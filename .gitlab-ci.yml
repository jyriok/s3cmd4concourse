variables:
  GIT_STRATEGY: clone

before_script:
    - apt-get update && apt-get install -y -qq kdiff3

stages:
  - build
#  - deploy

Merge:
  stage: build
  image: sfy-search-registry-build.artifactory.packages.install-os.multis.p.fti.net/build/docker:dind
  script:
    - git config --global user.email "bot@dev.null"
    - git config --global user.name "BOT4stemcells"
    - git config --global --add merge.tool kdiff3
    - git clone --single-branch -b stemcell4cs-3586.x https://github.com/jyriok/bosh-linux-stemcell-builder
    - cd bosh-linux-stemcell-builder
    - git remote add stemcell https://github.com/cloudfoundry/bosh-linux-stemcell-builder.git
    - git fetch --all
    - git branch -a
    - git checkout remotes/origin/stemcell4cs-3586.x
    #- git merge remotes/stemcell/3586.x
    - cd ci/docker
    - DOCKERID=$(sudo docker run --rm --privileged -v "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../..:/opt/bosh" --workdir /opt/bosh --user ubuntu -dt bosh/os-image-stemcell-builder uname -a)
    - docker exec $DOCKERID bash -c " \
      PATH=/home/ubuntu/.gem/ruby/2.3.1/bin:/opt/rubies/ruby-2.3.1/lib/ruby/gems/2.3.0/bin:/opt/rubies/ruby-2.3.1/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; \
      sudo gem install bundle ; \
      bundle install --local ; \
      bundle exec /opt/rubies/ruby-2.3.1/bin/rake stemcell:build_with_local_os_image[cloudstack,xen,ubuntu,trusty,$PWD/tmp/ubuntu_base_image.tgz,"3586.25"]"





